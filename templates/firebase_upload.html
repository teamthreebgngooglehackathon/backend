<!DOCTYPE html>
<html>
<head>
<title>Firebase File Upload</title>

<meta
name="viewport"
content="width=device-width, initial-scale=1, maximum-scale=1"
/>
</head>
<body>
    <form action="/postfirebase_upload/" method= "post">
        {% csrf_token %}
        <div>
            Upload Files<br />
            <input type="file" id="files" multiple /><br /><br />
            <input type="hidden" name="url" id="url" />
            <button id="send">Upload</button>
            <p id="uploading"></p>
            <progress value="0" max="100" id="progress"></progress>
            <button type="button" onclick="location.href='{% url 'createyourprofile' %}'">Go back to profile</button>
        </div>

        <!-- The core Firebase JS SDK is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-app.js"></script>

        <!-- TODO: Add SDKs for Firebase products that you want to use -->
        <script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-storage.js"></script>

        <script>
            // Your web app's Firebase configuration
            var firebaseConfig = {
               apiKey: "AIzaSyBxJTyBRe7bVkT_HaB6fHNxDc13mK-U8F8",
              authDomain: "afremote-a775b.firebaseapp.com",
              databaseURL: "https://afremote-a775b-default-rtdb.europe-west1.firebasedatabase.app",
              projectId: "afremote-a775b",
              storageBucket: "afremote-a775b.appspot.com",
              messagingSenderId: "261676390679",
              appId: "1:261676390679:web:99f87beb45060370fc3f52",
              measurementId: "G-KN81XFM62P"
            };
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
        </script>

        <script>
            var files = [];
            document.getElementById("files").addEventListener("change", function(e) {
              files = e.target.files;
              for (let i = 0; i < files.length; i++) {
                console.log(files[i]);
              }
            });

            document.getElementById("send").addEventListener("click", function() {
              //checks if files are selected
              if (files.length !== 0) {
                //Loops through all the selected files
                for (let i = 0; i < files.length; i++) {
                  //create a storage reference
                  var storage = firebase.storage().ref(files[i].name);
                  console.log(storage)

                  //upload file
                  var upload = storage.put(files[i]);

                  //update progress bar
                  upload.on(
                    "state_changed",
                    function progress(snapshot) {
                      var percentage =
                        (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                      document.getElementById("progress").value = percentage;
                    },

                    function error() {
                      alert("error uploading file");
                    },

                    function complete() {
                      document.getElementById(
                        "uploading"
                      ).innerHTML += `${files[i].name} uploaded <br />`;
                    }
                  );
                }
              } else {
                alert("No file chosen");
              }
            });

            function getFileUrl(filename) {
              //create a storage reference
              var storage = firebase.storage().ref(filename);

              //get file url
              storage
                .getDownloadURL()
                .then(function(url) {
                  document.getElementById('url').value = url;
                  console.log(url);
                })
                .catch(function(error) {
                  console.log("error encountered");
                });
            }
        </script>
    </form>
</body>
</html>